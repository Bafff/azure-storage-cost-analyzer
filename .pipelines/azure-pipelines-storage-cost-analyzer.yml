# Azure Storage Cost Monitor Pipeline
# This pipeline scans all Azure subscriptions for storage waste and sends metrics to Zabbix
#
# Schedule: Daily at 2 AM UTC (configurable)
# Trigger: Manual or scheduled
#
# Prerequisites:
#   1. Azure service connection with Reader + Cost Management Reader access to all subscriptions
#   2. Variable group 'zabbix-rs-credentials' with ZABBIX_SERVER variable
#   3. Zabbix server accessible on port 10051 from Azure DevOps agents
#   4. Zabbix host 'azure-storage-cost-analyzer' configured with template

name: Azure-Storage-Cost-Analyzer-$(Date:yyyyMMdd)-$(Rev:r)

trigger: none  # Disable CI triggers (manual or scheduled only)

schedules:
  - cron: "44 5 * * *"  # Daily at 5:44 AM UTC
    displayName: 'Daily Storage Cost Analysis'
    branches:
      include:
        - main
        - develop
    always: true  # Run even if no code changes

# Self-hosted Linux agent pool (update name to your pool). For hosted agents, swap this block for: `pool: { vmImage: "ubuntu-latest" }`
pool:
  name: 'ArkadiumOnline'
  demands:
    - Agent.OS -equals Linux

variables:
  - group: azure-storage-cost-analyzer  # Contains: ZABBIX_SERVER, optionally EXCLUDE_RESOURCE_GROUPS
  - name: ZABBIX_HOST
    value: 'azure-storage-cost-analyzer'
  - name: SCAN_DAYS
    value: 30  # Analyze last 30 days
  - name: AZURE_SERVICE_CONNECTION
    value: 'zabbix'
  - name: EXCLUDE_RG_AGE_THRESHOLD_DAYS_DISKS
    value: 7  # Disks older than this in excluded RGs will still be reported
  - name: EXCLUDE_RG_AGE_THRESHOLD_DAYS_SNAPSHOTS
    value: 60  # Snapshots have longer lifecycle, use higher threshold

stages:
  - stage: Analyze
    displayName: 'Azure Storage Cost Analysis'
    jobs:
      - job: ScanAllSubscriptions
        displayName: 'Scan All Azure Subscriptions'
        timeoutInMinutes: 30  # Adjust based on number of subscriptions

        steps:
          - checkout: self
            displayName: 'Checkout repository'
            clean: true

          - task: Bash@3
            displayName: 'Install dependencies'
            inputs:
              targetType: 'inline'
              script: |
                echo "Installing required packages..."
                sudo apt-get update -qq
                sudo apt-get install -y zabbix-sender jq bc coreutils

                echo "Verifying installations..."
                zabbix_sender --version
                jq --version
                bc --version

                echo "Dependencies installed successfully"

          - task: Bash@3
            displayName: 'Verify script permissions'
            inputs:
              targetType: 'inline'
              script: |
                chmod +x azure-storage-cost-analyzer.sh
                ls -la azure-storage-cost-analyzer.sh

          - task: AzureCLI@2
            displayName: 'Run Storage Cost Analysis'
            inputs:
              # NOTE: This is your Azure DevOps SERVICE CONNECTION name (NOT an Azure subscription ID)
              # The script will scan ALL Azure subscriptions that this service connection has access to
              # To create: Project Settings → Service connections → New service connection → Azure Resource Manager
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'  # ⚠️ UPDATE THIS to your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              # --skip-tagged: Exclude resources with valid future Resource-Next-Review-Date tags
              # This allows teams to mark resources as "reviewed" and avoid alerts until the review date expires
              inlineScript: |
                ./azure-storage-cost-analyzer.sh unused-report \
                  --subscriptions all \
                  --days $(SCAN_DAYS) \
                  --output-format json \
                  --skip-tagged \
                  --zabbix-send \
                  --zabbix-server $(ZABBIX_SERVER) \
                  --zabbix-host $(ZABBIX_HOST) \
                  --zabbix-port 10051 \
                  # EXCLUDE_RESOURCE_GROUPS provided by variable group 'azure-storage-cost-analyzer'
                  --exclude-resource-groups $(EXCLUDE_RESOURCE_GROUPS) \
                  --exclude-rg-age-threshold-days-disks $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_DISKS) \
                  --exclude-rg-age-threshold-days-snapshots $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_SNAPSHOTS) \
                  --quiet
              workingDirectory: '$(Build.SourcesDirectory)'
              failOnStandardError: false
            env:
              AZURE_CLI_TIMEOUT: 300  # 5 minutes timeout for Azure CLI commands
            continueOnError: false
            condition: succeeded()

          - task: Bash@3
            displayName: 'Summary Report'
            condition: always()
            inputs:
              targetType: 'inline'
              script: |
                echo "========================================"
                echo "Azure Storage Cost Analysis Complete"
                echo "========================================"
                echo "Build Number: $(Build.BuildNumber)"
                echo "Run Date: $(date)"
                echo "Zabbix Server: $(ZABBIX_SERVER)"
                echo "Zabbix Host: $(ZABBIX_HOST)"
                echo "Scan Period: Last $(SCAN_DAYS) days"
                echo "Excluded RGs: $(EXCLUDE_RESOURCE_GROUPS)"
                echo "Excluded RG Age Threshold (disks): $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_DISKS) days"
                echo "Excluded RG Age Threshold (snapshots): $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_SNAPSHOTS) days"
                echo ""
                echo "Command executed:"
                echo "  ./azure-storage-cost-analyzer.sh unused-report \\"
                echo "    --subscriptions all \\"
                echo "    --days $(SCAN_DAYS) \\"
                echo "    --output-format json \\"
                echo "    --skip-tagged \\"
                echo "    --zabbix-send \\"
                echo "    --zabbix-server $(ZABBIX_SERVER) \\"
                echo "    --zabbix-host $(ZABBIX_HOST) \\"
                echo "    --zabbix-port 10051 \\"
                echo "    --exclude-resource-groups $(EXCLUDE_RESOURCE_GROUPS) \\"
                echo "    --exclude-rg-age-threshold-days-disks $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_DISKS) \\"
                echo "    --exclude-rg-age-threshold-days-snapshots $(EXCLUDE_RG_AGE_THRESHOLD_DAYS_SNAPSHOTS) \\"
                echo "    --quiet"
                echo "========================================"

# Alternative: Single subscription scan (uncomment if needed)
#      - job: ScanSingleSubscription
#        displayName: 'Scan Specific Subscription'
#        variables:
#          SUBSCRIPTION_ID: 'your-subscription-id-here'
#        steps:
#          - task: AzureCLI@2
#            displayName: 'Run Analysis'
#            inputs:
#              azureSubscription: 'Azure-Service-Connection'
#              scriptType: 'bash'
#              scriptLocation: 'scriptPath'
#              scriptPath: '$(Build.SourcesDirectory)/azure-storage-cost-analyzer.sh'
#              arguments: |
#                unused-report \
#                --subscriptions $(SUBSCRIPTION_ID) \
#                --days $(SCAN_DAYS) \
#                --output-format json \
#                --zabbix-send \
#                --zabbix-server $(ZABBIX_SERVER) \
#                --zabbix-host $(ZABBIX_HOST)

# Optional: Notification on failure
#  - stage: Notify
#    displayName: 'Send Notifications'
#    dependsOn: Analyze
#    condition: failed()
#    jobs:
#      - job: NotifyTeam
#        steps:
#          - task: SendEmail@1  # Requires email extension
#            inputs:
#              To: 'devops-team@company.com'
#              Subject: 'Azure Storage Cost Analysis Failed'
#              Body: 'Pipeline $(Build.BuildNumber) failed. Check logs for details.'
